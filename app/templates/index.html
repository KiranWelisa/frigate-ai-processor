<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frigate AI Processor Dashboard</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1d; color: #f0f0f0; margin: 0; padding: 2rem; }
        .container { max-width: 1200px; margin: auto; }
        h1 { color: #6c757d; text-align: center; margin-bottom: 2rem; }
        .status-bar { display: flex; justify-content: space-around; background-color: #2c2f33; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; }
        .status-item { text-align: center; }
        .status-item h3 { margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #99aab5; text-transform: uppercase; }
        .status-item p { margin: 0; font-size: 1.2rem; font-weight: bold; }
        .status-item .status-connected { color: #43b581; }
        .status-item .status-disconnected { color: #f04747; }
        .header-controls { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 1rem; }
        .btn { background-color: #5865f2; color: white; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; border: none; cursor: pointer; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .panel { background-color: #2c2f33; padding: 1.5rem; border-radius: 8px; }
        .panel h2 { margin-top: 0; border-bottom: 1px solid #4f545c; padding-bottom: 0.5rem; }
        .log-box { background-color: #23272a; border-radius: 5px; padding: 1rem; height: 400px; overflow-y: auto; font-family: "Consolas", "Monaco", monospace; font-size: 0.85rem; }
        .log-box p { margin: 0 0 5px 0; word-break: break-all; }
        .log-info { color: #ffffff; }
        .log-debug { color: #99aab5; }
        .log-warning { color: #faa61a; }
        .log-error, .log-critical { color: #f04747; font-weight: bold; }
        #events-container { height: 434px; overflow-y: auto; }
        .event-card { display: flex; background-color: #36393f; border-radius: 5px; padding: 1rem; margin-bottom: 1rem; gap: 1rem; align-items: center; }
        .event-card img { width: 120px; height: 70px; object-fit: cover; border-radius: 4px; background-color: #23272a; }
        .event-info p { margin: 0 0 0.3rem 0; font-size: 0.9rem; }
        .event-info strong { color: #99aab5; }
        .event-status-analyzed { color: #43b581; }
        .event-status-filtered { color: #faa61a; }
        .event-status-failed { color: #f04747; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Frigate AI Processor Dashboard</h1>
        <div class="status-bar">
            <div class="status-item">
                <h3>MQTT Connection</h3>
                <p id="mqtt-status" class="status-disconnected">Disconnected</p>
            </div>
            <div class="status-item">
                <h3>Gemini AI</h3>
                <p id="gemini-status" class="status-disconnected">Not Initialized</p>
            </div>
        </div>

        <div class="header-controls">
            <a href="/config" class="btn">Configuration</a>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>Recent Events</h2>
                <div id="events-container">
                    </div>
            </div>
            <div class="panel">
                <h2>Live Logs</h2>
                <div class="log-box" id="log-box"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const logBox = document.getElementById('log-box');
        const eventsContainer = document.getElementById('events-container');
        const mqttStatus = document.getElementById('mqtt-status');
        const geminiStatus = document.getElementById('gemini-status');

        function scrollToBottom(element) {
            element.scrollTop = element.scrollHeight;
        }

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('log', (data) => {
            const logEntry = document.createElement('p');
            logEntry.className = `log-${data.level}`;
            logEntry.textContent = data.message;
            logBox.appendChild(logEntry);
            scrollToBottom(logBox);
        });

        socket.on('status_update', (data) => {
            if (data.type === 'mqtt') {
                mqttStatus.textContent = data.status;
                mqttStatus.className = data.status === 'Connected' ? 'status-connected' : 'status-disconnected';
            } else if (data.type === 'gemini') {
                geminiStatus.textContent = data.status;
                geminiStatus.className = data.status === 'Initialized' ? 'status-connected' : 'status-disconnected';
            }
        });
        
        socket.on('analysis_result', (data) => {
            let card = document.getElementById(`event-${data.event_id}`);
            if (!card) {
                card = document.createElement('div');
                card.className = 'event-card';
                card.id = `event-${data.event_id}`;
                eventsContainer.prepend(card);
            }
            
            let innerHTML = `<img src="/api/thumbnail/${data.event_id}" alt="Event thumbnail">`;
            
            if (data.status === 'Analyzed') {
                innerHTML += `
                    <div class="event-info">
                        <p><strong>Camera:</strong> ${data.camera}</p>
                        <p><strong>Detected:</strong> ${data.label}</p>
                        <p class="event-status-analyzed"><strong>Reiger:</strong> ${data.reiger_detected} (${(data.probability * 100).toFixed(1)}%)</p>
                    </div>`;
            } else if (data.status === 'Filtered') {
                innerHTML += `
                    <div class="event-info">
                        <p><strong>Camera:</strong> ${data.camera}</p>
                        <p><strong>Detected:</strong> ${data.label}</p>
                        <p class="event-status-filtered"><strong>Status:</strong> ${data.status}</p>
                    </div>`;
            } else if (data.status === 'Failed') {
                 innerHTML += `
                    <div class="event-info">
                        <p><strong>Event ID:</strong> ${data.event_id}</p>
                         <p class="event-status-failed"><strong>Status:</strong> Analysis Failed</p>
                         <p><small>${data.error}</small></p>
                    </div>`;
            } else { // Analyzing...
                 innerHTML += `
                    <div class="event-info">
                         <p><strong>Event ID:</strong> ${data.event_id}</p>
                         <p><strong>Status:</strong> ${data.status || 'Processing...'}</p>
                    </div>`;
            }

            card.innerHTML = innerHTML;
        });
    </script>
</body>
</html>
